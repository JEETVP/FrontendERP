<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Orden de Compra - Sistema Hospitalario</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; min-height: 100vh; }
        
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .navbar-brand { color: white; font-size: 20px; font-weight: 600; padding: 15px 0; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: #667eea; text-decoration: none; margin-bottom: 20px; }
        .form-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 40px; }
        .form-title { font-size: 28px; color: #333; font-weight: 600; margin-bottom: 30px; }
        
        .form-section { margin-bottom: 30px; padding-bottom: 25px; border-bottom: 1px solid #e0e0e0; }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        .required { color: #e74c3c; margin-left: 3px; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .help-text { font-size: 12px; color: #999; margin-top: 5px; }
        
        .lines-section { margin-top: 30px; }
        .line-item { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .btn-remove-line { position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .btn-add-line { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 15px; }
        
        .form-actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; padding-top: 25px; border-top: 1px solid #e0e0e0; }
        .btn { padding: 12px 28px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #f5f5f5; color: #666; }
        
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-error { background-color: #fee; color: #c33; border-left: 4px solid #c33; }
        .alert-success { background-color: #efe; color: #3c3; border-left: 4px solid #3c3; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .loading-overlay.show { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üè• Sistema Hospitalario</div>
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <div class="container">
        <a href="purchase-orders-list.html" class="back-link">‚Üê Volver a lista</a>

        <div class="form-card">
            <h1 class="form-title">Nueva Orden de Compra</h1>

            <div id="alert" class="alert"></div>

            <form id="poForm">
                <div class="form-section">
                    <h3 class="section-title">üìã Informaci√≥n General</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ID Hospital <span class="required">*</span></label>
                            <input type="text" id="hospital" required placeholder="ID del hospital">
                        </div>
                        <div class="form-group">
                            <label>ID Proveedor <span class="required">*</span></label>
                            <input type="text" id="supplier" required placeholder="ID del proveedor">
                        </div>
                        <div class="form-group">
                            <label>Moneda</label>
                            <select id="currency">
                                <option value="MXN">MXN</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tasa de Impuesto</label>
                            <input type="number" id="taxRate" value="0.16" step="0.01" min="0" max="1">
                            <small class="help-text">Ej: 0.16 para IVA 16%</small>
                        </div>
                        <div class="form-group full-width">
                            <label>Notas</label>
                            <textarea id="notes" rows="3" placeholder="Observaciones..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section lines-section">
                    <h3 class="section-title">üì¶ L√≠neas de Productos</h3>
                    <div id="linesContainer"></div>
                    <button type="button" class="btn-add-line" onclick="addLine()">‚ûï Agregar L√≠nea</button>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancel()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSubmit">Crear Orden</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://backenderp-316e.onrender.com/api';
        let lineCount = 0;

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = 'login.html'; return null; }
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user?.isSuperUser && user?.role !== 'admin' && user?.role !== 'manager') {
                alert('No tienes permisos');
                window.location.href = 'purchase-orders-list.html';
                return null;
            }
            return token;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function addLine() {
            lineCount++;
            const container = document.getElementById('linesContainer');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-item';
            lineDiv.id = `line-${lineCount}`;
            lineDiv.innerHTML = `
                <button type="button" class="btn-remove-line" onclick="removeLine(${lineCount})">‚úï Eliminar</button>
                <div class="form-grid" style="margin-top: 10px;">
                    <div class="form-group">
                        <label>ID Medicamento <span class="required">*</span></label>
                        <input type="text" class="line-medication" required placeholder="ID del medicamento">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <input type="text" class="line-description" placeholder="Descripci√≥n">
                    </div>
                    <div class="form-group">
                        <label>Cantidad <span class="required">*</span></label>
                        <input type="number" class="line-qty" required min="1" step="1" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Precio Unitario <span class="required">*</span></label>
                        <input type="number" class="line-price" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Unidad</label>
                        <input type="text" class="line-uom" value="unit" placeholder="unit">
                    </div>
                </div>
            `;
            container.appendChild(lineDiv);
        }

        function removeLine(id) {
            document.getElementById(`line-${id}`).remove();
        }

        function cancel() {
            if (confirm('¬øCancelar? Se perder√°n los datos')) {
                window.location.href = 'purchase-orders-list.html';
            }
        }

        document.getElementById('poForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const lines = [];
            document.querySelectorAll('.line-item').forEach(line => {
                const medication = line.querySelector('.line-medication').value.trim();
                const qty = parseFloat(line.querySelector('.line-qty').value);
                const unitPrice = parseFloat(line.querySelector('.line-price').value);
                const description = line.querySelector('.line-description').value.trim();
                const uom = line.querySelector('.line-uom').value.trim();

                if (medication && qty > 0 && unitPrice >= 0) {
                    lines.push({ medication, qty, unitPrice, description, uom });
                }
            });

            if (lines.length === 0) {
                showAlert('Debe agregar al menos una l√≠nea de producto', 'error');
                return;
            }

            const formData = {
                hospital: document.getElementById('hospital').value.trim(),
                supplier: document.getElementById('supplier').value.trim(),
                currency: document.getElementById('currency').value,
                taxRate: parseFloat(document.getElementById('taxRate').value),
                lines,
                notes: document.getElementById('notes').value.trim() || undefined
            };

            document.getElementById('btnSubmit').disabled = true;
            document.getElementById('loadingOverlay').classList.add('show');

            try {
                const response = await fetch(`${API_BASE_URL}/purchase-orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok && data.ok) {
                    showAlert('Orden de compra creada exitosamente', 'success');
                    setTimeout(() => {
                        window.location.href = 'purchase-orders-list.html?created=true';
                    }, 1500);
                } else {
                    showAlert(data.message || 'Error al crear orden', 'error');
                    document.getElementById('btnSubmit').disabled = false;
                }
            } catch (error) {
                showAlert('Error de conexi√≥n', 'error');
                document.getElementById('btnSubmit').disabled = false;
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        });

        // Inicializar
        (function init() {
            checkAuth();
            addLine(); // Agregar primera l√≠nea
        })();
    </script>
</body>
</html>