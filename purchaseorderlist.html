<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de √ìrdenes de Compra - Sistema Hospitalario</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; min-height: 100vh; }
        
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .navbar-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .navbar-brand { color: white; font-size: 20px; font-weight: 600; padding: 15px 0; }
        .navbar-menu { display: flex; list-style: none; gap: 5px; }
        .navbar-menu li a { color: white; text-decoration: none; padding: 20px 18px; display: block; transition: background 0.3s; font-size: 14px; font-weight: 500; }
        .navbar-menu li a:hover { background: rgba(255,255,255,0.1); }
        .navbar-menu li a.active { background: rgba(255,255,255,0.2); border-bottom: 3px solid white; }
        .navbar-user { display: flex; align-items: center; gap: 15px; color: white; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: #667eea; text-decoration: none; font-size: 14px; margin-bottom: 20px; font-weight: 500; }
        .page-header { background: white; padding: 25px 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 28px; color: #333; font-weight: 600; }
        .btn-add { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; text-decoration: none; }
        
        .filters { background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 500; }
        .filter-group input, .filter-group select { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .btn-filter { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8f9fa; }
        thead th { padding: 16px 20px; text-align: left; font-weight: 600; color: #555; font-size: 13px; text-transform: uppercase; }
        tbody tr { border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        tbody tr:hover { background: #f8f9ff; }
        tbody td { padding: 18px 20px; color: #333; font-size: 14px; }
        
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-draft { background: #f5f5f5; color: #666; }
        .badge-sent { background: #e3f2fd; color: #1976d2; }
        .badge-received { background: #e8f5e9; color: #2e7d32; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .loading-overlay.show { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .pagination { display: flex; justify-content: center; gap: 10px; padding: 20px; }
        .page-btn { padding: 8px 16px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; }
        .page-btn.active { background: #667eea; color: white; border-color: #667eea; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üè• Sistema Hospitalario</div>
            <ul class="navbar-menu">
                <li><a href="users-list.html">Usuarios</a></li>
                <li><a href="medications.html">Medicamentos</a></li>
                <li><a href="suppliers.html">Proveedores</a></li>
                <li><a href="purchase-orders.html" class="active">Compras</a></li>
                <li><a href="inventory-transactions-list.html">Inventario</a></li>
                <li><a href="notifications-list.html">Notificaciones</a></li>
            </ul>
            <div class="navbar-user">
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <div class="container">
        <a href="purchase-orders.html" class="back-link">‚Üê Volver al men√∫</a>

        <div class="page-header">
            <h1 class="page-title">Lista de √ìrdenes de Compra</h1>
            <a href="purchase-order-create.html" class="btn-add" id="btnAdd">‚ûï Nueva Orden</a>
        </div>

        <div class="filters">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Hospital ID</label>
                    <input type="text" id="filterHospital" placeholder="ID del hospital">
                </div>
                <div class="filter-group">
                    <label>Proveedor ID</label>
                    <input type="text" id="filterSupplier" placeholder="ID del proveedor">
                </div>
                <div class="filter-group">
                    <label>Estado</label>
                    <select id="filterStatus">
                        <option value="">Todos</option>
                        <option value="DRAFT">Borrador</option>
                        <option value="SENT">Enviada</option>
                        <option value="RECEIVED">Recibida</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>C√≥digo</label>
                    <input type="text" id="filterCode" placeholder="C√≥digo de OC">
                </div>
            </div>
            <button class="btn-filter" onclick="applyFilters()">üîç Buscar</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Hospital</th>
                        <th>Proveedor</th>
                        <th>Estado</th>
                        <th>Total</th>
                        <th>L√≠neas</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div style="font-size: 64px;">üì¶</div>
                <div style="font-size: 20px; color: #666; margin-top: 20px;">No hay √≥rdenes de compra</div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://backenderp-316e.onrender.com/api';
        let currentPage = 1;
        let currentFilters = {};

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = 'login.html'; return null; }
            return token;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatPrice(price) {
            return `$${Number(price || 0).toFixed(2)}`;
        }

        function getStatusBadge(status) {
            const badges = {
                DRAFT: '<span class="badge badge-draft">Borrador</span>',
                SENT: '<span class="badge badge-sent">Enviada</span>',
                RECEIVED: '<span class="badge badge-received">Recibida</span>'
            };
            return badges[status] || status;
        }

        async function loadOrders(page = 1) {
            const token = checkAuth();
            if (!token) return;

            document.getElementById('loadingOverlay').classList.add('show');

            try {
                const params = new URLSearchParams({
                    page,
                    limit: 20,
                    ...currentFilters
                });

                const response = await fetch(`${API_BASE_URL}/purchase-orders?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok && data.ok) {
                    renderOrders(data.data);
                    renderPagination(data.meta);
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            const emptyState = document.getElementById('emptyState');
            
            tbody.innerHTML = '';

            if (!orders || orders.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            orders.forEach(po => {
                const row = document.createElement('tr');
                row.onclick = () => window.location.href = `purchase-order-detail.html?id=${po._id}`;
                row.innerHTML = `
                    <td><strong>${po.code || 'N/A'}</strong></td>
                    <td>${po.hospital?.name || po.hospital || 'N/A'}</td>
                    <td>${po.supplier?.name || po.supplier || 'N/A'}</td>
                    <td>${getStatusBadge(po.status)}</td>
                    <td><strong>${formatPrice(po.total)} ${po.currency || 'MXN'}</strong></td>
                    <td>${po.lines?.length || 0}</td>
                    <td>${formatDate(po.createdAt)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPagination(meta) {
            const pagination = document.getElementById('pagination');
            if (!meta || meta.pages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= meta.pages; i++) {
                html += `<button class="page-btn ${i === meta.page ? 'active' : ''}" onclick="loadOrders(${i})">${i}</button>`;
            }
            pagination.innerHTML = html;
            currentPage = meta.page;
        }

        function applyFilters() {
            currentFilters = {};
            const hospital = document.getElementById('filterHospital').value.trim();
            const supplier = document.getElementById('filterSupplier').value.trim();
            const status = document.getElementById('filterStatus').value;
            const code = document.getElementById('filterCode').value.trim();

            if (hospital) currentFilters.hospital = hospital;
            if (supplier) currentFilters.supplier = supplier;
            if (status) currentFilters.status = status;
            if (code) currentFilters.code = code;

            loadOrders(1);
        }

        // Inicializar
        (function init() {
            const token = checkAuth();
            if (token) {
                const user = JSON.parse(localStorage.getItem('user'));
                const hasPermission = user?.isSuperUser || user?.role === 'admin' || user?.role === 'manager';
                if (!hasPermission) document.getElementById('btnAdd').style.display = 'none';
                loadOrders();
            }
        })();
    </script>
</body>
</html>